<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Motet</title>
    <!--
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js"></script>
    <script src="https://www.gstatic.com/cast/sdk/libs/sender/1.0/cast_framework.js"></script>
    -->
    <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
    <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/all.js" integrity="sha384-xymdQtn1n3lH2wcu0qhcdaOpQwyoarkgLVxC/wZ5q7h9gHtxICrpcaSUfygqZGOe" crossorigin="anonymous"></script>
</head>
  <body>
    <div>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="navbar-brand" href="#">Motet</a>
            <span class="ml-auto">
                <button is="google-cast-button" class="my-2 my-sm-0" style="height: 30px; width: 30px"></button>
            </span>
        </nav>
    </div>    
    <div id="root" class="container-fluid">

    </div>
    
    <script>
        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
            initializeCastApi();
            }
        };

        var player = null;
        var playerController = null;
        var connected = null;

        console.log(location.origin);

        initializeCastApi = function() {
            cast.framework.CastContext.getInstance().setOptions({
                receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
                autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
            });

            console.log(cast.framework.CastContext.getInstance());
            
            player = new cast.framework.RemotePlayer();
            playerController = new cast.framework.RemotePlayerController(player);

            playerController.addEventListener(
                cast.framework.RemotePlayerEventType.IS_CONNECTED_CHANGED, 
                event => {
                    console.log(event);
                    if(player.isConnected) {
                        connected = true;
                        console.log("player.isConnected");
                    }
                }
            );
        };

    </script>

    <script type="text/babel">

    class Motet extends React.Component {
        constructor(props) {
            super(props);
            this.state = {
                error: null,
                isLoaded: false,
                items: [],
                albums: [],
                artists: [],
                songs: [],
                artist: null,
                album: null,
              };

            this.playMusic = this.playMusic.bind(this);
            this.addSongToQueue = this.addSongToQueue.bind(this);
            
            this.getArtists_OnClick = this.getArtists_OnClick.bind(this);
            this.getArtistAlbums_OnClick = this.getArtistAlbums_OnClick.bind(this);
            this.getArtistAlbumSongs_OnClick = this.getArtistAlbumSongs_OnClick.bind(this);
        }

        getArtists_OnClick(e) {
            this.getArtists();
        }

        getArtistAlbums_OnClick(artist, e) {
            this.getArtistAlbums(artist);
        }

        getArtistAlbumSongs_OnClick(album, e) {
            if(this.state.artist)
                this.getArtistAlbumSongs(this.state.artist, album);
        }

        getArtists() {
            fetch(location.origin + '/artists')
                .then(res => res.json())
                .then(result => {
                    this.setState({
                        error: null,
                        isLoaded: true,
                        artists: result,
                        albums: null,
                        songs: null
                    });
                },
                error => {
                    this.setState({
                        error: error,
                        isLoaded: false
                    });
                })
        }

        getArtistAlbums(artist) {
            fetch(location.origin + '/artist/' + artist)
                .then(res => res.json())
                .then(result => {
                    console.log(result);
                    this.setState({
                        error: null,
                        isLoaded: true,
                        artists: null,
                        albums: result,
                        songs: null,
                        artist: artist
                    });
                },
                error => {
                    this.setState({
                        error: error,
                        isLoaded: false,
                        artist: null
                    });
                })
        }

        getArtistAlbumSongs(artist, album) {
            fetch(location.origin + '/artist/' + artist + '/album/' + album)
                .then(res => res.json())
                .then(result => {
                    this.setState({
                        error: null,
                        isLoaded: true,
                        artists: null,
                        albums: null,
                        songs: result,
                        album: album
                    });
                },
                error => {
                    this.setState({
                        error: error,
                        isLoaded: false,
                        album: album
                    });
                })
        }

        getAlbums() {
            fetch(location.origin + '/albums')
                .then(res => res.json())
                .then(result => {
                    this.setState({
                        error: null,
                        isLoaded: true,
                        albums: result
                    });
                },
                error => {
                    this.setState({
                        error: error,
                        isLoaded: false
                    });
                })
        }

        componentDidMount() {
            this.getArtists();
        }
      
        componentWillUnmount() {
      
        }

        getContentType(dataformat) {
            switch(dataformat) {
                case "mp3":
                    return "audio/mpeg3";
                case "flac":
                    return "audio/flac";
                case "ogg":
                    return "audio/ogg";
                case "opus":
                    return "audio/opus";              
            }
            return "audio/mpeg3";
        }

        getSongMetadata(item) {
            var meta = new chrome.cast.media.MusicTrackMediaMetadata();
            meta.artist = item.artist;
            meta.title = item.title;
            meta.track = item.track;
            meta.albumName = item.album;

            return meta;
        }

        playMusic(item, e) {
            console.log(item.md5);
            console.log(e);

            if(connected) {
                console.log("Jag 채r kopplad");
                var castSession = cast.framework.CastContext.getInstance().getCurrentSession();
                console.log(castSession);
                var currentMediaURL = location.origin + "/music/" + item.md5;
                var contentType = this.getContentType(item.dataformat);
                var mediaInfo = new chrome.cast.media.MediaInfo(currentMediaURL, contentType);

                mediaInfo.metadata = this.getSongMetadata(item);
                var request = new chrome.cast.media.LoadRequest(mediaInfo);
                castSession.loadMedia(request).then(
                    () => { console.log('Load succeed'); },
                    errorCode => { console.log('Error code: ' + errorCode); });
            } else {
                console.log("Nej jag 채r inte kopplad")
            } 
        }

        addSongToQueue(item, e) {
            console.log(item.md5);
            console.log(e);

            if(connected) {
                console.log("Jag 채r kopplad");
                var castSession = cast.framework.CastContext.getInstance().getCurrentSession().getSessionObj();

                console.log(castSession);
                var currentMediaURL = location.origin + "/music/" + item.md5;
                var contentType = this.getContentType(item.dataformat);

                var mediaInfo = new chrome.cast.media.MediaInfo(currentMediaURL, contentType);

                mediaInfo.metadata = this.getSongMetadata(item);

                var queueItem = new chrome.cast.media.QueueItem(mediaInfo);

                var request = new chrome.cast.media.QueueInsertItemsRequest([queueItem]); 
                castSession.queueLoad(request,
                    () => { console.log('Added to queue succeed'); },
                    errorCode => { console.log('Error code: ' + errorCode); });
            } else {
                console.log("Nej jag 채r inte kopplad")
            } 
        }

        getSongList(items) {
            return (<ul className="list-group list-group-flush">
                    {items.map(item => (
                      <li className="list-group-item">
                          <p>
                              {item.title}
                              <button type="button" onClick={(e) => this.playMusic(item, e)} className='btn button-primary btn-sm ml-3' style={{backgroundColor: "transparent"}}>
                                  <i className="fas fa-play"></i>
                              </button>
                              
                              <button type="button" onClick={(e) => this.addSongToQueue(item, e)} className='btn button-primary btn-sm ml-3' style={{backgroundColor: "transparent"}}>
                                  <i class="fas fa-plus"></i>
                              </button>
                          </p>
                          <small>{item.artist} {item.album}</small>
                      </li>
                    ))}
                  </ul>);
        }

        getAlbumsList(items) {
            return (<div className="list-group list-group-flush">
                    {items.map(album => (
                      <a href="#" onClick={(e) => this.getArtistAlbumSongs_OnClick(album, e)} className="list-group-item list-group-item-action">
                          {album}
                      </a>
                    ))}
                </div>);
        }

        getArtistsList(items) {
            return (<div className="list-group list-group-flush">
                    {items.map(artist => (
                      <a href="#" onClick={(e) => this.getArtistAlbums_OnClick(artist, e)} className="list-group-item list-group-item-action">
                          {artist}
                      </a>
                    ))}
                    </div>);
        }

        render() {
            const { error, isLoaded, items, artists, albums, songs } = this.state;
            if (error) {
              return <div>Error: {error.message}</div>;
            } else if (!isLoaded) {
              return <div>Loading...</div>;
            } else if (artists) {
                return (
                    <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item active" aria-current="page">Artists</li>
                        </ol>
                    </nav>
                    {this.getArtistsList(artists)}
                    </div>
              );
            } else if (albums) {
                return (
                    <div>
                    <nav aria-label="breadcrumb">
                        <ol className="breadcrumb">
                            <li className="breadcrumb-item"><a href="#" onClick={(e) => this.getArtists_OnClick(e)}>Artists</a></li>
                            <li className="breadcrumb-item active" aria-current="page">{this.state.artist}</li>
                        </ol>
                    </nav>
                    
                        {this.getAlbumsList(albums)}
                    </div>
                );
            } else if (songs) {
                return (
                    <div>
                    <nav aria-label="breadcrumb">
                        <ol className="breadcrumb">
                            <li className="breadcrumb-item"><a href="#" onClick={(e) => this.getArtists_OnClick(e)}>Artists</a></li>
                            <li className="breadcrumb-item"><a href="#" onClick={(e) => this.getArtistAlbums_OnClick(this.state.artist, e)}>{this.state.artist}</a></li>
                            <li className="breadcrumb-item active" aria-current="page">{this.state.album}</li>
                        </ol>
                    </nav>
                    
                        {this.getSongList(songs)}
                    </div>
                );
            }

        }
    }

      ReactDOM.render(
        <Motet />,
        document.getElementById('root')
      );

    </script>
    <!--
      Note: this page is a great way to try React but it's not suitable for production.
      It slowly compiles JSX with Babel in the browser and uses a large development build of React.

      To set up a production-ready React build environment, follow these instructions:
      * https://reactjs.org/docs/add-react-to-a-new-app.html
      * https://reactjs.org/docs/add-react-to-an-existing-app.html

      You can also use React without JSX, in which case you can remove Babel:
      * https://reactjs.org/docs/react-without-jsx.html
      * https://reactjs.org/docs/cdn-links.html
    --> 
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
   
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script> 
  </body>
</html>